---
import type { Locale } from '@/utils/i18n';
import { getLocalizedPath, useTranslations } from '@/utils/i18n';
import LanguageSwitcher from './LanguageSwitcher.astro';
import DarkModeToggle from './DarkModeToggle.astro';

export interface Props {
  locale: Locale;
}

const { locale } = Astro.props;
const t = useTranslations(locale);

const navigationItems = [
  { href: '/about', label: t('nav.about') },
  { href: '/research', label: t('nav.research_page') },
  {
    href: '/services',
    label: t('nav.services'),
    dropdown: [
      { href: '/services/research', label: t('nav.research') },
      { href: '/services/proofreading', label: t('nav.proofreading') },
      { href: '/services/translation', label: t('nav.translation') },
    ]
  },
  { href: '/blog', label: t('nav.blog') },
  { href: '/contact', label: t('nav.contact') },
];

// Check if current page matches navigation item
function isActive(href: string, exact: boolean = false): boolean {
  const currentPath = Astro.url.pathname;
  const localizedHref = getLocalizedPath(href, locale);

  if (exact) {
    return currentPath === localizedHref;
  }
  return currentPath.startsWith(localizedHref);
}
---

<header class="py-8 bg-warm-50 dark:bg-dark-50">
  <div class="max-w-4xl mx-auto px-6">
    <div class="flex justify-between items-center">
      <!-- Minimal logo/name -->
      <a
        href={getLocalizedPath('/about', locale)}
        class="flex items-center gap-2 text-warm-900 dark:text-dark-900 font-medium hover:text-hover-light dark:hover:text-hover-dark transition-colors text-lg"
      >
        <img src="/lavender.png" alt="Lavender" class="h-8 w-auto" />
        <span>J<span class="text-[#BFAEDC]">M</span> Sugawara</span>
      </a>

      <!-- Desktop navigation -->
      <nav class="hidden md:flex items-center space-x-8">
        {navigationItems.map((item) => (
          item.dropdown ? (
            <!-- Dropdown menu item -->
            <div class="relative group">
              <a
                href={getLocalizedPath(item.href, locale)}
                class={`text-sm transition-colors flex items-center space-x-1 ${
                  isActive(item.href, item.exact)
                    ? 'text-warm-900 dark:text-dark-900 font-medium'
                    : 'text-warm-700 dark:text-dark-700 hover:text-hover-light dark:hover:text-hover-dark'
                }`}
              >
                <span>{item.label}</span>
                <svg class="w-3 h-3 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
              </a>
              <!-- Dropdown menu -->
              <div class="absolute left-0 mt-2 py-2 bg-warm-50 dark:bg-dark-100 border border-warm-300 dark:border-dark-300 rounded-md shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 ease-in-out z-50 min-w-max">
                {item.dropdown.map((subItem) => (
                  <a
                    href={getLocalizedPath(subItem.href, locale)}
                    class="block px-4 py-2 text-sm text-warm-700 dark:text-dark-700 hover:text-hover-light dark:hover:text-hover-dark hover:bg-warm-100 dark:hover:bg-dark-200 transition-colors whitespace-nowrap"
                  >
                    {subItem.label}
                  </a>
                ))}
              </div>
            </div>
          ) : (
            <!-- Regular menu item -->
            <a
              href={getLocalizedPath(item.href, locale)}
              class={`text-sm transition-colors ${
                isActive(item.href, item.exact)
                  ? 'text-warm-900 dark:text-dark-900 font-medium'
                  : 'text-warm-700 dark:text-dark-700 hover:text-hover-light dark:hover:text-hover-dark'
              }`}
            >
              {item.label}
            </a>
          )
        ))}
      </nav>

      <!-- Dark mode toggle, language switcher and mobile menu -->
      <div class="flex items-center space-x-4">
        <div class="hidden sm:block">
          <DarkModeToggle />
        </div>
        <div class="hidden sm:block">
          <LanguageSwitcher locale={locale} />
        </div>

        <!-- Mobile menu button -->
        <button
          type="button"
          class="md:hidden text-warm-700 dark:text-dark-700 hover:text-hover-light dark:hover:text-hover-dark transition-colors"
          id="mobile-menu-button"
          aria-label="Menu"
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile menu -->
    <div class="md:hidden hidden mt-6 pt-6 border-t border-warm-300 dark:border-dark-300" id="mobile-menu">
      <div class="space-y-4">
        {navigationItems.map((item) => (
          item.dropdown ? (
            <div class="space-y-2">
              <a
                href={getLocalizedPath(item.href, locale)}
                class={`text-sm font-medium block transition-colors ${
                  isActive(item.href, item.exact)
                    ? 'text-warm-900 dark:text-dark-900'
                    : 'text-warm-700 dark:text-dark-700 hover:text-hover-light dark:hover:text-hover-dark'
                }`}
              >
                {item.label}
              </a>
              <div class="pl-4 space-y-2">
                {item.dropdown.map((subItem) => (
                  <a
                    href={getLocalizedPath(subItem.href, locale)}
                    class="block text-sm text-warm-600 dark:text-dark-600 hover:text-hover-light dark:hover:text-hover-dark transition-colors"
                  >
                    {subItem.label}
                  </a>
                ))}
              </div>
            </div>
          ) : (
            <a
              href={getLocalizedPath(item.href, locale)}
              class={`block text-sm transition-colors ${
                isActive(item.href, item.exact)
                  ? 'text-warm-900 dark:text-dark-900 font-medium'
                  : 'text-warm-700 dark:text-dark-700 hover:text-hover-light dark:hover:text-hover-dark'
              }`}
            >
              {item.label}
            </a>
          )
        ))}
        <div class="pt-4 sm:hidden flex items-center space-x-3">
          <LanguageSwitcher locale={locale} />
          <span class="text-warm-400 dark:text-dark-400">|</span>
          <DarkModeToggle />
        </div>
      </div>
    </div>
  </div>
</header>

<script>
  const mobileMenuButton = document.getElementById('mobile-menu-button');
  const mobileMenu = document.getElementById('mobile-menu');

  if (mobileMenuButton && mobileMenu) {
    mobileMenuButton.addEventListener('click', () => {
      mobileMenu.classList.toggle('hidden');
    });
  }
</script>