---
import type { Locale } from '@/utils/i18n';
import { locales, languageNames, getLocalizedPath, removeLocalePrefix } from '@/utils/i18n';

export interface Props {
  locale: Locale;
  class?: string;
}

const { locale, class: className = '' } = Astro.props;

// Get current path without locale prefix for switching
const currentPath = removeLocalePrefix(Astro.url.pathname);

// Generate unique IDs to handle multiple instances
const uniqueId = crypto.randomUUID().slice(0, 8);
const buttonId = `language-switcher-button-${uniqueId}`;
const menuId = `language-switcher-menu-${uniqueId}`;
---

<div class={`relative ${className}`}>
  <button
    type="button"
    class="text-sm text-warm-700 hover:text-warm-900 transition-colors w-full text-left"
    id={buttonId}
    aria-label="Switch Language"
    aria-expanded="false"
    aria-haspopup="true"
  >
    {locale.toUpperCase()}
  </button>

  <div
    class="absolute left-0 sm:right-0 sm:left-auto mt-2 py-2 bg-warm-100 border border-warm-300 rounded-md shadow-lg opacity-0 invisible transition-all duration-200 ease-in-out z-[9999] min-w-max"
    id={menuId}
    role="menu"
    aria-labelledby={buttonId}
  >
    {locales.map((switchLocale) => (
      <a
        href={getLocalizedPath(currentPath, switchLocale)}
        class={`block px-3 py-1 text-sm transition-colors whitespace-nowrap hover:bg-warm-200 ${
          switchLocale === locale
            ? 'text-warm-900 font-medium'
            : 'text-warm-700 hover:text-warm-900'
        }`}
        role="menuitem"
      >
        {languageNames[switchLocale].native}
      </a>
    ))}
  </div>
</div>

<script define:vars={{ buttonId, menuId }}>
  const button = document.getElementById(buttonId);
  const menu = document.getElementById(menuId);

  if (button && menu) {
    let isOpen = false;

    const openMenu = () => {
      isOpen = true;
      button.setAttribute('aria-expanded', 'true');
      menu.classList.remove('opacity-0', 'invisible');
      menu.classList.add('opacity-100', 'visible');
    };

    const closeMenu = () => {
      isOpen = false;
      button.setAttribute('aria-expanded', 'false');
      menu.classList.add('opacity-0', 'invisible');
      menu.classList.remove('opacity-100', 'visible');
    };

    button.addEventListener('click', (e) => {
      e.stopPropagation();
      if (isOpen) {
        closeMenu();
      } else {
        // Close any other open language switchers
        document.querySelectorAll('[id^="language-switcher-menu-"]').forEach((otherMenu) => {
          if (otherMenu !== menu && otherMenu.classList.contains('visible')) {
            otherMenu.classList.add('opacity-0', 'invisible');
            otherMenu.classList.remove('opacity-100', 'visible');
          }
        });
        document.querySelectorAll('[id^="language-switcher-button-"]').forEach((otherButton) => {
          if (otherButton !== button) {
            otherButton.setAttribute('aria-expanded', 'false');
          }
        });
        openMenu();
      }
    });

    // Close on outside click
    document.addEventListener('click', (e) => {
      if (!button.contains(e.target) && !menu.contains(e.target)) {
        closeMenu();
      }
    });

    // Close on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && isOpen) {
        closeMenu();
        button.focus();
      }
    });
  }
</script>